# Overview of DHT functionality

DHT is a distributed key value store in use by PSP to achieve anonymous and secure communication between peers on the network.

DHT is an implementation of [Kademlia](https://en.wikipedia.org/wiki/Kademlia) modeled after and derived in part from [Ipfs](ipfs.io) with S/Kademlia modifications to mitigate vulnerability to a [Sybil](https://en.bitcoin.it/wiki/Weaknesses#Sybil_attack) attack

PSP clients depend on DHT to facilitate the ability of onion nodes to provide private and secure communication between parties utilizing the PSP network.

DHT is responsible for recording and making information available in a fast, secure, stable, and scalable manner in order to make secure communication between clients on the PSP network possible without sacrificing privacy

### A Brief History of Kademlia

>Kademlia (DHT) is a distributed hash table for decentralized peer-to-peer computer networks designed by Petar Maymounkov and David MaziÃ¨res in 2002. It specifies the structure of the network and the exchange of information through node lookups. Kademlia nodes communicate among themselves using UDP. A virtual or overlay network is formed by the participant nodes. Each node is identified by a number or node ID. The node ID serves not only as identification, but the Kademlia algorithm uses the node ID to locate values (usually file hashes or keywords). In fact, the node ID provides a direct map to file hashes and that node stores information on where to obtain the file or resource.
>When searching for some value, the algorithm needs to know the associated key and explores the network in several steps. Each step will find nodes that are closer to the key until the contacted node returns the value or no more closer nodes are found. This is very efficient: Like many other DHTs, Kademlia contacts only O(log&#8322;n) nodes during the search out of a total of n nodes in the system.
>Further advantages are found particularly in the decentralized structure, which increases the resistance against a denial-of-service attack (DDoS). Even if a whole set of nodes is flooded, this will have limited effect on network availability, since the network will recover itself by knitting the network around these "holes".

Kademlia offers:

* Efficient lookup though massive networks: queries on average contact &#8968;log&#8322;n&#8969; nodes
* Low coordination cost, control messages sent to neighbors are minimal
* Secure from common attacks
* Wide adoption in a number of projects including BitTorrent

### S/Kademlia

S/Kademlia refers to an implementation of Kademlia with modifications to mitigate so called Sybil attacks
> a Sybil attack occurs when an adversary attempts to fill the network with clients they control. This facilitates a host of avenues of exploitation for the successful attacker including: traffic analysis, denial of service (DoS), or man-in-the-middle type attacks

In order to resist such attacks DHT extends Kademlia with features which enhance the security of the network including secure `nodeID` assignment. `nodeID` in DHT is generated by taking the sha256 digest of the 2048 bit RSA key identifying the PSP node hosting the instance of DHT. This reduces vulnerability to Sybil type attack by increasing the difficulty of generating a large number of `nodeIDs` quickly as well as authenticating the node, as the `nodeID` must match the sha256 fingerprint of the nodes RSA identity key

In addition to secure `nodeID` generation S/Kademlia nodes use cryptographically signed messages to communicate, further securing the network from malicious entities

S/Kademlia nodes perform lookup over disjoint paths to ensure malicious nodes will not prevent honest nodes from connecting to each other in networks containing a large portion of adversarial nodes

### Overlay networks

An overlay network is a computer network built on top of another network, in this case the DHT network is built on top of the PSP network, which in turn is built on top of the wider internet

### Ipfs

Interplanetary Filesystem [whitepaper](https://github.com/ipfs/ipfs/blob/master/papers/ipfs-cap2pfs/ipfs-p2p-file-system.pdf) is a distributed filesystem combining successful ideas from a number of peer-to-peer systems.

DHT extends Ipfs to implement a secure distributed storage medium

### How DHT Works

DHT nodes form an overlay network on top of PSP, the nodes communicate through the secure onion network provided by PSP to find peers, as well as store and retrieve values from the datastore

Each node is identified by a `nodeID` which is generated from the 2048 bit RSA identity key of the host PSP node to provide security from Sybil attacks from adversarial nodes on the network

The node contains a local datastore for storing key value pairs, as well as a routing table which is used to locate peers on the network

Peer lookup is performed by using a distance calculation defined as exclusive-or (XOR) to transfrom a `PeerID` into an integer useful for locating a peer.

The routing table within a node consists of a list of _n_ k-buckets holding nodes with a distance _d_ where 2&#8317;&#8305; &#8315; &#185;&#8318; <= _d_ < 2 &#8305; with 0 <= i <= n along with a sorted list of siblings

Queries for peers are performed via disjoint paths to avoid failure upon encountering an adversarial node in the lookup path, as was the case in prior implementations of Kademlia

The initiator starts a lookup by taking the k closest nodes to the destination key from his local routing table and distributing them into d independent lookup buckets. The node continues from there with d parallel lookups similar to traditional Kademlia lookup. These lookups are independent except that each node is only used once during the whole lookup procedure to ensure the resultant paths are disjoint.

The `Find value` procedure in DHT follows a similar process as finding a node. The node initiating the request simply locates the k closest peers to the key, upon receipt of the value the initiator also stores the returned value at the closest peer who did not return the value for caching purposes.

Storing a value follows a similar process, the participant node locates the k closest nodes to the key and sends them a `Store` RPC, additionally each node re-publishes the (key, value) pairs to keep them alive prior to their expiration and removal from the store.

Further reading on [Kademlia](https://pdos.csail.mit.edu/~petar/papers/maymounkov-kademlia-lncs.pdf)

DHT nodes in PSP provide the ability for clients to communicate securely and privately by allowing onion nodes to publish presence information for clients requesting that functionality. That presence information can then be requested by any other client on the network, allowing the onion nodes to them form a bridge between clients to facilitate secure and private communication between parties without compromising the location of any party on the network